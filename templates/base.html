{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>UNEMS | University Event Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
  </head>

  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="{% url 'dashboard' %}"> UNEMS </a>

        <button
          class="navbar-toggler"
          data-bs-toggle="collapse"
          data-bs-target="#navContent"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navContent">
          <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item">
              <a class="nav-link" href="{% url 'event_list' %}">Events</a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="{% url 'notice_list' %}">Notices</a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="{% url 'user_notifications' %}"
                >Notifications</a
              >
            </li>

            <li class="nav-item dropdown me-3">
              <a
                class="nav-link position-relative"
                href="#"
                id="notifDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <i class="bi bi-bell fs-5"></i>

                {% if unread_notifications_count and unread_notifications_count > 0 %}
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        {{ unread_notifications_count }}
                    </span>
                {% endif %}

              </a>

              <ul
                class="dropdown-menu dropdown-menu-end shadow"
                aria-labelledby="notifDropdown"
                style="min-width: 320px"
              >
                <li class="dropdown-header fw-semibold">Notifications</li>
                {% if latest_notifications %}
                    {% for n in latest_notifications %}
                        <li class="dropdown-item small {% if not n.is_read %}fw-semibold{% endif %}">
                            {{ n.message|truncatechars:80 }}<br>
                            <span class="text-muted">{{ n.created_at|date:"M d, H:i" }}</span>
                        </li>
                    {% endfor %}
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item text-center" href="{% url 'user_notifications' %}">
                            View all
                        </a>
                    </li>
                {% else %}
                    <li class="dropdown-item text-muted small">No notifications</li>
                {% endif %}

              </ul>
            </li>

            {% if user.is_staff %}
            <li class="nav-item dropdown ms-3">
              <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown"
                >Admin</a
              >
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a
                    class="dropdown-item"
                    href="{% url 'admin_event_dashboard' %}"
                    >Manage Events</a
                  >
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="{% url 'admin_notice_dashboard' %}"
                    >Manage Notices</a
                  >
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="{% url 'admin_notification_dashboard' %}"
                    >Manage Notifications</a
                  >
                </li>
              </ul>
            </li>
            {% endif %}

            <li class="nav-item ms-3">
              <span class="text-white me-3 fw-semibold">
                {{ request.user.username }}
              </span>
            </li>

            <li class="nav-item">
              <a class="btn btn-danger btn-sm" href="{% url 'logout' %}"
                >Logout</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container py-4">
      {% if messages %} {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      {% endfor %} {% endif %} {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!--<script>
      (function() {
          {% if user.is_authenticated %}
          const protocol = window.location.protocol === "https:" ? "wss" : "ws";
          const socket = new WebSocket(protocol + "://" + window.location.host + "/ws/notifications/");

          socket.onmessage = function(e) {
              const data = JSON.parse(e.data);

              // 1. Update badge count
              const badge = document.querySelector('#notifDropdown .badge');
              if (badge) {
                  const current = parseInt(badge.textContent || '0');
                  badge.textContent = current + 1;
              } else {
                  // Create badge if it doesn't exist
                  const link = document.getElementById('notifDropdown');
                  if (link) {
                      const span = document.createElement('span');
                      span.className = "position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger";
                      span.textContent = '1';
                      link.appendChild(span);
                  }
              }

              // 2. Optionally prepend into dropdown list (if it's open)
              const dropdownMenu = document.querySelector('#notifDropdown + .dropdown-menu');
              if (dropdownMenu) {
                  const li = document.createElement('li');
                  li.className = 'dropdown-item small fw-semibold';
                  li.innerHTML = `
                      ${data.message}<br>
                      <span class="text-muted">${data.created_at}</span>
                  `;
                  dropdownMenu.insertBefore(li, dropdownMenu.children[1]); // after header
              }
          };

          socket.onclose = function(e) {
              console.log("Notification socket closed.");
          };
          {% endif %}
      })();
    </script>-->
  </body>
</html>
